{% extends 'base.html' %}
{% block title %}Day Trading Model{% endblock %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1>Day Trading Model</h1>
      <p class="text-muted">
        Momentum-driven intraday classifier trained on Yahoo Finance 1-minute data.
      </p>
    </div>
    <div>
      <button id="train-button" class="btn btn-success">Train / Retrain</button>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Model configuration</div>
        <div class="card-body">
          <form id="train-form" class="row gy-2">
            <div class="col-md-6">
              <label class="form-label" for="symbol">Symbol</label>
              <input type="text" class="form-control" id="symbol" name="symbol" value="{{ model_config.symbol }}" />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="lookback_days">Lookback days</label>
              <input type="number" class="form-control" id="lookback_days" name="lookback_days" value="{{ model_config.lookback_days }}" min="1" max="30" />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="epochs">Epochs</label>
              <input type="number" class="form-control" id="epochs" name="epochs" value="{{ model_config.epochs }}" min="1" max="50" />
            </div>
            <div class="col-md-6">
              <label class="form-label" for="threshold">Target threshold</label>
              <input type="number" class="form-control" id="threshold" name="threshold" value="{{ model_config.threshold }}" step="0.0001" />
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="force_download" name="force_download" />
                <label class="form-check-label" for="force_download">Force fresh data download</label>
              </div>
            </div>
          </form>
          <div class="mt-3">
            <div class="alert alert-info" id="train-status" role="alert" style="display:none"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Latest evaluation</div>
        <div class="card-body">
          {% if metrics.evaluation %}
            <table class="table table-dark table-striped table-sm">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody id="metrics-table">
                {% for key, value in metrics.evaluation.items() %}
                  <tr>
                    <td>{{ key }}</td>
                    <td>{{ '%.4f'|format(value) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p class="text-muted">Train the model to view evaluation metrics.</p>
            <table class="table table-dark table-striped table-sm" style="display:none" id="metrics-table"></table>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Training progress</div>
    <div class="card-body">
      <div class="chart-container">
        <canvas id="history-chart"></canvas>
      </div>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Real-time signal monitor</div>
    <div class="card-body">
      <div class="chart-container mb-3">
        <canvas id="price-chart"></canvas>
      </div>
      <div class="chart-container">
        <canvas id="prob-chart"></canvas>
      </div>
      <p class="text-muted mt-3">
        The monitor refreshes every minute using the latest yfinance data and the trained model.
      </p>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Broker integration checklist</div>
    <div class="card-body">
      <ol>
        <li>Generate paper trading API keys from a broker such as <a href="https://alpaca.markets/" target="_blank" rel="noopener">Alpaca</a>.</li>
        <li>Set the environment variables <code>BROKER_API_KEY</code>, <code>BROKER_API_SECRET</code> and <code>BROKER_BASE_URL</code> before launching the app.</li>
        <li>Implement order execution inside <code>trading_models/broker/alpaca_client.py</code> (stub provided) and call it from the streaming loop.</li>
        <li>Switch from the paper endpoint to live trading only after validating the strategy and adding risk controls.</li>
      </ol>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    window.__INITIAL_HISTORY__ = {{ history_plot | tojson }};
    window.__INITIAL_METRICS__ = {{ metrics | tojson }};
  </script>
  <script src="{{ url_for('static', filename='js/day_trading.js') }}"></script>
{% endblock %}
